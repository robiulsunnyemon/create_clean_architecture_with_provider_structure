//create_individual_component.dart

import 'dart:io';

void main(List<String> arguments) {
  if (arguments.length < 3) {
    print('‚ùå Please provide correct arguments. Usage:');
    print('   dart run tool/create_individual_component.dart into [feature_name] for [component_name] [-s|-l]');
    print('   dart run tool/create_individual_component.dart into home for cart -s');
    print('   dart run tool/create_individual_component.dart into home for cart -l');
    return;
  }

  final featureName = arguments[1]; // home
  final componentName = arguments[3]; // cart
  final isList = arguments.length > 4 && arguments[4] == '-l';

  print('üöÄ Creating component: $componentName in feature: $featureName');
  print('üì¶ Response type: ${isList ? 'List' : 'Single'}');

  _createComponentStructure(featureName, componentName, isList);
  _createComponentFiles(featureName, componentName, isList);

  print('\n‚úÖ Component "$componentName" created successfully in "$featureName" feature!');
  print('\nüìù Next steps:');
  print('   1. Add the new provider to main.dart MultiProvider');
  print('   2. Use the provider in your screens');
  print('   3. Perform HOT RESTART');
}

void _createComponentStructure(String featureName, String componentName, bool isList) {
  // Check if feature exists
  if (!Directory('lib/features/$featureName').existsSync()) {
    print('‚ùå Feature "$featureName" does not exist!');
    print('üí° Please create the feature first using:');
    print('   dart run tool/create_screen_smart.dart ${_capitalize(featureName)}Screen');
    exit(1);
  }

  final directories = [
    'lib/features/$featureName/data/datasources',
    'lib/features/$featureName/data/models',
    'lib/features/$featureName/data/repositories',
    'lib/features/$featureName/domain/entities',
    'lib/features/$featureName/domain/repositories',
    'lib/features/$featureName/domain/usecases',
    'lib/features/$featureName/presentation/providers',
  ];

  for (final dir in directories) {
    try {
      Directory(dir).createSync(recursive: true);
    } catch (e) {
      // Directory already exists - this is fine
    }
  }
}

void _createComponentFiles(String featureName, String componentName, bool isList) {
  final className = _capitalize(componentName);
  final snakeCaseName = _convertToSnakeCase(componentName);

  // Domain Layer - Entity (‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá Entity ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶¨‡ßá)
  _createFile('lib/features/$featureName/domain/entities/${snakeCaseName}_entity.dart', '''
class ${className}Entity {
  final String id;
  final String title;
  final double price;
  final int quantity;
  
  const ${className}Entity({
    required this.id,
    required this.title,
    required this.price,
    required this.quantity,
  });

  // Copy with method for easy updates
  ${className}Entity copyWith({
    String? id,
    String? title,
    double? price,
    int? quantity,
  }) {
    return ${className}Entity(
      id: id ?? this.id,
      title: title ?? this.title,
      price: price ?? this.price,
      quantity: quantity ?? this.quantity,
    );
  }

  @override
  String toString() {
    return '${className}Entity(id: \$id, title: \$title, price: \$price, quantity: \$quantity)';
  }

  @override
  bool operator ==(Object other) {
    if (identical(this, other)) return true;
  
    return other is ${className}Entity &&
      other.id == id &&
      other.title == title &&
      other.price == price &&
      other.quantity == quantity;
  }

  @override
  int get hashCode {
    return id.hashCode ^
      title.hashCode ^
      price.hashCode ^
      quantity.hashCode;
  }
}
''');

  // Data Layer - Model (Entity ‡¶ï‡ßá extends ‡¶ï‡¶∞‡ßá)
  _createFile('lib/features/$featureName/data/models/${snakeCaseName}_model.dart', '''
import '../../domain/entities/${snakeCaseName}_entity.dart';

class ${className}Model extends ${className}Entity {
  ${className}Model({
    required super.id,
    required super.title,
    required super.price,
    required super.quantity,
  });

  // JSON ‚Üí Dart object
  factory ${className}Model.fromJson(Map<String, dynamic> json) {
    return ${className}Model(
      id: json['id']?.toString() ?? '',
      title: json['title']?.toString() ?? '',
      price: (json['price'] as num?)?.toDouble() ?? 0.0,
      quantity: (json['quantity'] as num?)?.toInt() ?? 0,
    );
  }

  // Model ‚Üí JSON
  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'title': title,
      'price': price,
      'quantity': quantity,
    };
  }

  // Entity ‚Üí Model
  factory ${className}Model.fromEntity(${className}Entity entity) {
    return ${className}Model(
      id: entity.id,
      title: entity.title,
      price: entity.price,
      quantity: entity.quantity,
    );
  }

  // Model ‚Üí Entity (automatically available due to inheritance)
  ${className}Entity toEntity() {
    return ${className}Entity(
      id: id,
      title: title,
      price: price,
      quantity: quantity,
    );
  }

  // Copy with method
  @override
  ${className}Model copyWith({
    String? id,
    String? title,
    double? price,
    int? quantity,
  }) {
    return ${className}Model(
      id: id ?? this.id,
      title: title ?? this.title,
      price: price ?? this.price,
      quantity: quantity ?? this.quantity,
    );
  }
}
''');

  // Data Layer - Remote Data Source
  final responseType = isList ? 'List<${className}Model>' : '${className}Model';
  final apiResponse = isList
      ? '[${className}Model(id: "1", title: "$componentName Item 1", price: 29.99, quantity: 2), ${className}Model(id: "2", title: "$componentName Item 2", price: 39.99, quantity: 1)]'
      : '${className}Model(id: "1", title: "$componentName Item", price: 29.99, quantity: 1)';

  _createFile('lib/features/$featureName/data/datasources/${snakeCaseName}_remote_data_source.dart', '''
import '../../../../core/errors/exceptions.dart';
import '../models/${snakeCaseName}_model.dart';

abstract class ${className}RemoteDataSource {
  Future<$responseType> get${className}Data();
}

class ${className}RemoteDataSourceImpl implements ${className}RemoteDataSource {
  @override
  Future<$responseType> get${className}Data() async {
    try {
      // Implement your API call here
      await Future.delayed(const Duration(milliseconds: 500));
      return $apiResponse;
    } catch (e) {
      throw ServerException('Failed to fetch $componentName data');
    }
  }
}
''');

  // Data Layer - Repository Implementation
  final entityResponseType = isList ? 'List<${className}Entity>' : '${className}Entity';
  final repositoryMethodBody = isList ? '''
    if (await networkInfo.isConnected) {
      try {
        final models = await remoteDataSource.get${className}Data();
        // Models automatically are Entities (due to inheritance)
        return Right(models);
      } on ServerException catch (e) {
        return Left(ServerFailure(e.message));
      }
    } else {
      return Left(NetworkFailure('No internet connection'));
    }
  ''' : '''
    if (await networkInfo.isConnected) {
      try {
        final model = await remoteDataSource.get${className}Data();
        // Model automatically is Entity (due to inheritance)
        return Right(model);
      } on ServerException catch (e) {
        return Left(ServerFailure(e.message));
      }
    } else {
      return Left(NetworkFailure('No internet connection'));
    }
  ''';

  _createFile('lib/features/$featureName/data/repositories/${snakeCaseName}_repository_impl.dart', '''
import 'package:dartz/dartz.dart';
import '../../../../core/errors/exceptions.dart';
import '../../../../core/errors/failures.dart';
import '../../../../core/network/network_info.dart';
import '../../domain/entities/${snakeCaseName}_entity.dart';
import '../../domain/repositories/${snakeCaseName}_repository.dart';
import '../datasources/${snakeCaseName}_remote_data_source.dart';

class ${className}RepositoryImpl implements ${className}Repository {
  final ${className}RemoteDataSource remoteDataSource;
  final NetworkInfo networkInfo;

  ${className}RepositoryImpl({
    required this.remoteDataSource,
    required this.networkInfo,
  });

  @override
  Future<Either<Failure, $entityResponseType>> get${className}Data() async {
    $repositoryMethodBody
  }
}
''');

  // Domain Layer - Repository Interface
  _createFile('lib/features/$featureName/domain/repositories/${snakeCaseName}_repository.dart', '''
import 'package:dartz/dartz.dart';
import '../../../../core/errors/failures.dart';
import '../entities/${snakeCaseName}_entity.dart';

abstract class ${className}Repository {
  Future<Either<Failure, ${isList ? 'List<${className}Entity>' : '${className}Entity'}>> get${className}Data();
}
''');

  // Domain Layer - Use Cases
  _createFile('lib/features/$featureName/domain/usecases/get_${snakeCaseName}_usecase.dart', '''
import 'package:dartz/dartz.dart';
import '../../../../core/errors/failures.dart';
import '../repositories/${snakeCaseName}_repository.dart';
import '../entities/${snakeCaseName}_entity.dart';

class Get${className}UseCase {
  final ${className}Repository repository;

  Get${className}UseCase(this.repository);

  Future<Either<Failure, ${isList ? 'List<${className}Entity>' : '${className}Entity'}>> call() {
    return repository.get${className}Data();
  }
}
''');

  // Presentation Layer - State
  final stateType = isList ? 'List<${className}Entity>' : '${className}Entity';
  final stateLoaded = isList ? '${className}ListLoaded' : '${className}Loaded';

  _createFile('lib/features/$featureName/presentation/state/${snakeCaseName}_state.dart', '''
import 'package:flutter/material.dart';
import '../../domain/entities/${snakeCaseName}_entity.dart';

@immutable
abstract class ${className}State {
  const ${className}State();
}

class ${className}Initial extends ${className}State {}

class ${className}Loading extends ${className}State {}

class ${stateLoaded} extends ${className}State {
  final $stateType data;

  const ${stateLoaded}(this.data);
}

class ${className}Error extends ${className}State {
  final String message;

  const ${className}Error(this.message);
}
''');

  // Presentation Layer - Provider
  _createFile('lib/features/$featureName/presentation/providers/${snakeCaseName}_provider.dart', '''
import 'package:flutter/material.dart';
import 'package:dartz/dartz.dart';
import '../../domain/usecases/get_${snakeCaseName}_usecase.dart';
import '../../domain/entities/${snakeCaseName}_entity.dart';
import '../state/${snakeCaseName}_state.dart';

class ${className}Provider with ChangeNotifier {
  final Get${className}UseCase get${className}UseCase;
  ${className}State _state = ${className}Initial();
  ${isList ? 'List<${className}Entity> _items = [];' : '${className}Entity? _item;'}

  ${className}Provider({required this.get${className}UseCase});

  ${className}State get state => _state;
  ${isList ? 'List<${className}Entity> get items => _items;' : '${className}Entity? get item => _item;'}

  Future<void> get${className}Data() async {
    _state = ${className}Loading();
    notifyListeners();

    final result = await get${className}UseCase();

    result.fold(
      (failure) {
        _state = ${className}Error(failure.toString());
      },
      (${isList ? 'entities' : 'entity'}) {
        ${isList ? '_items = entities;' : '_item = entity;'}
        _state = ${stateLoaded}(${isList ? 'entities' : 'entity'});
      },
    );

    notifyListeners();
  }

  ${isList ? '''
  // Additional methods for list operations
  void addItem(${className}Entity item) {
    _items.add(item);
    _state = ${className}ListLoaded(_items);
    notifyListeners();
  }

  void removeItem(String itemId) {
    _items.removeWhere((item) => item.id == itemId);
    _state = ${className}ListLoaded(_items);
    notifyListeners();
  }

  void updateItemQuantity(String itemId, int newQuantity) {
    final index = _items.indexWhere((item) => item.id == itemId);
    if (index != -1) {
      final updatedItem = _items[index].copyWith(quantity: newQuantity);
      _items[index] = updatedItem;
      _state = ${className}ListLoaded(_items);
      notifyListeners();
    }
  }

  void clearItems() {
    _items.clear();
    _state = ${className}ListLoaded(_items);
    notifyListeners();
  }
  ''' : '''
  // Additional methods for single item operations
  void updateItem(${className}Entity updatedItem) {
    _item = updatedItem;
    _state = ${className}Loaded(updatedItem);
    notifyListeners();
  }

  void updateQuantity(int newQuantity) {
    if (_item != null) {
      _item = _item!.copyWith(quantity: newQuantity);
      _state = ${className}Loaded(_item!);
      notifyListeners();
    }
  }

  void clearItem() {
    _item = null;
    _state = ${className}Initial();
    notifyListeners();
  }
  '''}
}
''');

  print('\nüìã Created all files for $componentName component in $featureName feature');
}

String _convertToSnakeCase(String text) {
  return text.replaceAllMapped(
    RegExp(r'[A-Z]'),
        (match) => match.start == 0
        ? match.group(0)!.toLowerCase()
        : '_${match.group(0)!.toLowerCase()}',
  );
}

String _capitalize(String text) {
  if (text.isEmpty) return text;
  return '${text[0].toUpperCase()}${text.substring(1)}';
}

void _createFile(String path, String content) {
  try {
    final file = File(path);
    final directory = file.parent;
    if (!directory.existsSync()) {
      directory.createSync(recursive: true);
    }

    if (file.existsSync()) {
      print('‚ö†Ô∏è  File already exists: $path');
      return;
    }

    file.writeAsStringSync(content);
    print('üìÑ Created: $path');
  } catch (e) {
    print('‚ùå Failed to create file: $path - $e');
  }
}
